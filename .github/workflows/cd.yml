on:
  push:
    branches:
      - master

jobs:
  migrate-db:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        name: Checkout Repository

      - name: Install Golang Migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/bin/
          which migrate

      - name: Running Migrate DB
        run: make db_up DB_URL="${{secrets.PROD_POSTGRES_URL}}"

  deploy-job:
    needs:
      - migrate-db
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    env:
      SVC_ID: ${{ github.event.repository.name }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4.2.2
        name: Checkout Repository

      - name: Deploy to Railway
        run: |
          railway add --service $SVC_ID \
            --image ${{ secrets.DOCKERHUB_USERNAME }}/${{secrets.IMAGE_NAME}}:${{secrets.IMAGE_TAG}} \
            --variables PORT=${{ secrets.PORT }} \
            --variables CACHE_DB_NAME=${{ secrets.REDIS_NAME }} \
            --variables CACHE_DB_HOST=${{ secrets.PROD_REDIS_HOST }} \
            --variables CACHE_DB_PORT=${{ secrets.PROD_REDIS_PORT }} \
            --variables CACHE_DB_USER=${{ secrets.PROD_REDIS_USER }} \
            --variables CACHE_DB_PASS=${{ secrets.PROD_REDIS_PASSWORD }} \
            --variables CACHE_DB_MAX_CON=${{ secrets.REDIS_MAX_CON }} \
            --variables CACHE_DB_MIN_CON=${{ secrets.REDIS_MIN_CON }} \
            --variables CACHE_DB_MAX_TIME=${{ secrets.REDIS_MAX_TIME }} \
            --variables CACHE_DB_MIN_TIME=${{ secrets.REDIS_MIN_TIME }} \
            --variables MODEL_PATH=${{ secrets.MODEL_PATH }} \
            --variables FIBER_HOST=${{ secrets.FIBER_HOST }} \
            --variables FIBER_PORT=${{ secrets.FIBER_PORT }} \
            --variables FIBER_PREFORK=${{ secrets.FIBER_PREFORK }} \
            --variables FIBER_STRICT_ROUTING=${{ secrets.FIBER_STRICT_ROUTING }} \
            --variables FIBER_CASE_SENSITIVE=${{ secrets.FIBER_CASE_SENSITIVE }} \
            --variables FIBER_BODY_LIMIT=${{ secrets.FIBER_BODY_LIMIT }} \
            --variables FIBER_READ_TIMEOUT=${{ secrets.FIBER_READ_TIMEOUT }} \
            --variables FIBER_WRITE_TIMEOUT=${{ secrets.FIBER_WRITE_TIMEOUT }} \
            --variables FIBER_REDUCE_MEMU=${{ secrets.FIBER_REDUCE_MEMU }} \
            --variables FIBER_JSON=${{ secrets.FIBER_JSON }} \
            --variables HASH_SALT=${{ secrets.PROD_HASH_SALT }} \
            --variables LOG_PATH=${{ secrets.LOG_PATH }} \
            --variables LOG_MAX_SIZE=${{ secrets.LOG_MAX_SIZE }} \
            --variables LOG_MAX_BACKUP=${{ secrets.LOG_MAX_BACKUP }} \
            --variables LOG_MAX_SIZE_ROTATE=${{ secrets.LOG_MAX_SIZE_ROTATE }} \
            --variables LOG_TIME_FORMAT=${{ secrets.LOG_TIME_FORMAT }} \
            --variables LOG_COLOR_OUTPUT=${{ secrets.LOG_COLOR_OUTPUT }} \
            --variables LOG_QUOTE_STR=${{ secrets.LOG_QUOTE_STR }} \
            --variables LOG_END_WITH_MESSAGE=${{ secrets.LOG_END_WITH_MESSAGE }} \
            --variables DB_DRIVER=${{ secrets.POSTGRES_DRIVER }} \
            --variables DB_PROTOCOL=${{ secrets.POSTGRES_PROTOCOL }} \
            --variables DB_NAME=${{ secrets.PROD_POSTGRES_DB }} \
            --variables DB_HOST=${{ secrets.PROD_POSTGRES_HOST }} \
            --variables DB_PORT=${{ secrets.PROD_POSTGRES_PORT }} \
            --variables DB_USER=${{ secrets.PROD_POSTGRES_USER }} \
            --variables DB_PASS=${{ secrets.PROD_POSTGRES_PASSWORD }} \
            --variables DB_MAX_CON=${{ secrets.POSTGRES_MAX_CON }} \
            --variables DB_MIN_CON=${{ secrets.POSTGRES_MIN_CON }} \
            --variables DB_MAX_TIME=${{ secrets.POSTGRES_MAX_TIME }} \
            --variables DB_MIN_TIME=${{ secrets.POSTGRES_MIN_TIME }} \
            --variables TOKEN_NAME=${{ secrets.PROD_TOKEN_NAME }} \
            --variables SECRET_KEY_ACCESS_TOKEN=${{ secrets.PROD_SECRET_KEY_ACCESS_TOKEN }} \
            --variables SECRET_KEY_REFRESH_TOKEN=${{ secrets.PROD_SECRET_KEY_REFRESH_TOKEN }} \
            --variables SECRET_KEY_FP_TOKEN=${{ secrets.PROD_SECRET_KEY_FP_TOKEN }} \ 
            --variables SECRET_KEY_CSRF=${{ secrets.PROD_SECRET_KEY_CSRF }} \
            --variables SECRET_TEST_CLIENT=${{ secrets.PROD_SECRET_TEST_CLIENT }} \ 
            --variables CACHE_TIMEOUT=${{ secrets.REDIS_TIMEOUT }} \
            --variables DB_TIMEOUT=${{ secrets.POSTGRES_TIMEOUT }} \
            --variables DOWN_STREAM_TIMEOUT=${{ secrets.DOWN_STREAM_TIMEOUT }} \
            --variables CORS_ALLOW_METHODS=${{ secrets.CORS_ALLOW_METHODS }} \
            --variables CORS_ALLOW_HEADERS=${{ secrets.CORS_ALLOW_HEADERS }} \
            --variables CORS_EXPOSE_HEADERS=${{ secrets.CORS_EXPOSE_HEADERS }} \
            --variables CORS_ALLOW_ORIGINS=${{ secrets.PROD_CORS_ALLOW_ORIGINS }} \ 
            --variables CORS_ALLOW_CREDENTIALS=${{ secrets.CORS_ALLOW_CREDENTIALS }}